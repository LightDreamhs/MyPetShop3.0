<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.petshop.backend.mapper.CustomerMapper">

    <resultMap id="BaseResultMap" type="com.petshop.backend.entity.Customer">
        <id column="id" property="id"/>
        <result column="pet_name" property="petName"/>
        <result column="owner_name" property="ownerName"/>
        <result column="phone" property="phone"/>
        <result column="is_member" property="isMember"/>
        <result column="member_level" property="memberLevel"/>
        <result column="balance" property="balance"/>
        <result column="avatar" property="avatar"/>
        <result column="pet_type" property="petType"/>
        <result column="breed" property="breed"/>
        <result column="age" property="age"/>
        <result column="gender" property="gender"/>
        <result column="notes" property="notes"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <select id="findByPage" resultMap="BaseResultMap">
        SELECT id, pet_name, owner_name, phone, is_member, member_level, balance, avatar, pet_type, breed, age, gender, notes, created_at, updated_at
        FROM customers
        <where>
            <if test="search != null and search != ''">
                AND (owner_name LIKE CONCAT('%', #{search}, '%')
                OR phone LIKE CONCAT('%', #{search}, '%'))
            </if>
            <if test="isMember != null">
                AND is_member = #{isMember}
            </if>
            <if test="memberLevel != null">
                AND member_level = #{memberLevel}
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countByCondition" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM customers
        <where>
            <if test="search != null and search != ''">
                AND (owner_name LIKE CONCAT('%', #{search}, '%')
                OR phone LIKE CONCAT('%', #{search}, '%'))
            </if>
            <if test="isMember != null">
                AND is_member = #{isMember}
            </if>
            <if test="memberLevel != null">
                AND member_level = #{memberLevel}
            </if>
        </where>
    </select>

    <select id="findById" resultMap="BaseResultMap">
        SELECT id, pet_name, owner_name, phone, is_member, member_level, balance, avatar, pet_type, breed, age, gender, notes, created_at, updated_at
        FROM customers
        WHERE id = #{id}
    </select>

    <insert id="insert" parameterType="com.petshop.backend.entity.Customer" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO customers (pet_name, owner_name, phone, is_member, member_level, avatar, pet_type, breed, age, gender, notes)
        VALUES (#{petName}, #{ownerName}, #{phone}, #{isMember}, #{memberLevel}, #{avatar}, #{petType}, #{breed}, #{age}, #{gender}, #{notes})
    </insert>

    <update id="update" parameterType="com.petshop.backend.entity.Customer">
        UPDATE customers
        SET pet_name = #{petName},
            owner_name = #{ownerName},
            phone = #{phone},
            is_member = #{isMember},
            member_level = #{memberLevel},
            avatar = #{avatar},
            pet_type = #{petType},
            breed = #{breed},
            age = #{age},
            gender = #{gender},
            notes = #{notes}
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM customers
        WHERE id = #{id}
    </delete>

    <update id="updateBalance">
        UPDATE customers
        SET balance = #{balance}
        WHERE id = #{id}
    </update>

</mapper>
